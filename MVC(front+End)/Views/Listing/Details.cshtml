@model MVC_front_End_.Models.ListingDTO

@{
    ViewData["Title"] = Model.Title;
    var ratingText = Model.ReviewCount > 0 ? Model.AverageRating.ToString("0.0") : "New";
    var reviewText = Model.ReviewCount > 0 ? $"{Model.ReviewCount} reviews" : "No reviews yet";
}

<!-- ERROR ALERT (Visible if something fails) -->
@if (TempData["Error"] != null)
{
    <div class="alert alert-danger text-center shadow fixed-top m-3" style="z-index: 2000; max-width: 600px; left: 50%; transform: translateX(-50%);">
        <i class="bi bi-exclamation-triangle-fill me-2"></i> @TempData["Error"]
        <button type="button" class="btn-close ms-2" data-bs-dismiss="alert"></button>
    </div>
}

<div class="container" style="margin-top: 30px; margin-bottom: 100px;">
    
    <!-- HEADER -->
    <div class="mb-4">
        <h1 class="fw-bold mb-2">@Model.Title</h1>
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
            <div class="d-flex align-items-center gap-1 small fw-bold text-decoration-underline">
                <i class="bi bi-star-fill text-danger"></i> 
                <span>@ratingText</span> 
                <span class="mx-1">·</span>
                <span class="fw-bold text-decoration-underline">@reviewText</span>
                <span class="mx-1">·</span>
                <span class="fw-bold text-decoration-underline">@Model.CityName, Egypt</span>
            </div>
            <div class="d-flex gap-3">
                <button class="btn btn-light btn-sm rounded-pill px-3 border-0 hover-bg-gray"><i class="bi bi-share me-2"></i>Share</button>
                <button class="btn btn-light btn-sm rounded-pill px-3 border-0 hover-bg-gray"><i class="bi bi-heart me-2"></i>Save</button>
            </div>
        </div>
    </div>

    <!-- PHOTO CAROUSEL -->
    <div id="listingCarousel" class="carousel slide rounded-4 overflow-hidden shadow-sm mb-5" data-bs-ride="carousel">
        
        <div class="carousel-indicators">
            @for (int i = 0; i < Model.Photos.Count; i++)
            {
                <button type="button" data-bs-target="#listingCarousel" data-bs-slide-to="@i" class="@(i == 0 ? "active" : "")"></button>
            }
        </div>

        <div class="carousel-inner" style="height: 500px;">
            @if (Model.Photos != null && Model.Photos.Any())
            {
                int index = 0;
                foreach (var photo in Model.Photos)
                {
                    <div class="carousel-item h-100 @(index == 0 ? "active" : "")">
                        
                        <img src="https://localhost:7151@(photo.Url)" class="d-block w-100 h-100" style="object-fit: cover;" alt="Listing Photo" onerror="this.src='https://via.placeholder.com/800x500?text=No+Image'">
                    </div>
                    index++;
                }
            }
            else
            {
                <div class="carousel-item active h-100">
                    <div class="d-flex justify-content-center align-items-center h-100 bg-light text-muted">
                        <i class="bi bi-image fs-1 display-1"></i>
                    </div>
                </div>
            }
        </div>

        <button class="carousel-control-prev" type="button" data-bs-target="#listingCarousel" data-bs-slide="prev">
            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
        </button>
        <button class="carousel-control-next" type="button" data-bs-target="#listingCarousel" data-bs-slide="next">
            <span class="carousel-control-next-icon" aria-hidden="true"></span>
        </button>
    </div>

    <div class="row position-relative">
        <!-- LEFT COLUMN: DETAILS -->
        <div class="col-lg-7 col-xl-8">
            <div class="border-bottom pb-4 mb-4">
                <h3 class="fw-bold mb-1">Entire @Model.Category hosted by Host</h3>
                <p class="text-muted mb-0">@Model.Capacity guests </p>
            </div>

            <!-- Features -->
            <div class="border-bottom pb-4 mb-4">
                <div class="d-flex gap-3 mb-4">
                    <i class="bi bi-door-open fs-3 text-dark"></i>
                    <div>
                        <div class="fw-bold">Self check-in</div>
                        <div class="text-muted small">Check yourself in with the keypad.</div>
                    </div>
                </div>
                <div class="d-flex gap-3 mb-4">
                    <i class="bi bi-geo-alt fs-3 text-dark"></i>
                    <div>
                        <div class="fw-bold">Great location</div>
                        <div class="text-muted small">100% of recent guests gave the location a 5-star rating.</div>
                    </div>
                </div>
                <div class="d-flex gap-3">
                    <i class="bi bi-calendar-check fs-3 text-dark"></i>
                    <div>
                        <div class="fw-bold">Free cancellation for 48 hours</div>
                    </div>
                </div>
            </div>

            <!-- Description -->
            <div class="mb-5 pb-4 border-bottom">
                <h4 class="fw-bold">About this place</h4>
                <p class="text-muted mt-3" style="line-height: 1.6;">@Model.Description</p>
            </div>
            
            <!-- Amenities -->
            <div class="mb-5 pb-4 border-bottom">
                <h4 class="fw-bold mb-4">What this place offers</h4>
                <div class="row g-3">
                    @if(Model.AmenityNames != null && Model.AmenityNames.Any()) {
                        foreach(var am in Model.AmenityNames) {
                            <div class="col-md-6">
                                <div class="d-flex align-items-center gap-3">
                                    <i class="bi bi-check2-circle fs-5"></i> 
                                    <span>@am</span>
                                </div>
                            </div>
                        }
                    } else {
                        <p class="text-muted">No specific amenities listed.</p>
                    }
                </div>
            </div>

            <!-- Reviews Section -->
            <div class="mb-5">
                <h4 class="fw-bold mb-4">
                    <i class="bi bi-star-fill text-danger me-2"></i> @ratingText · @reviewText
                </h4>

                @if (Model.Reviews != null && Model.Reviews.Any())
                {
                    <div class="row g-4">
                        @foreach (var review in Model.Reviews)
                        {
                            <div class="col-md-6">
                                <div class="mb-2">
                                    <div class="d-flex align-items-center gap-3 mb-2">
                                        <div class="bg-light text-dark border rounded-circle d-flex align-items-center justify-content-center fw-bold" style="width: 45px; height: 45px;">
                                            @(string.IsNullOrEmpty(review.GuestName) ? "?" : review.GuestName.Substring(0,1).ToUpper())
                                        </div>
                                        <div>
                                            <div class="fw-bold text-dark">@review.GuestName</div>
                                            
                                        </div>
                                    </div>
                                    <div class="mb-2 small text-warning">
                                        @for(int i=0; i<review.Rating; i++) { <i class="bi bi-star-fill"></i> }
                                    </div>
                                    <p class="text-dark small text-truncate-3">@review.Comment</p>
                                </div>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <p class="text-muted">No reviews yet. Be the first to stay!</p>
                }
            </div>
        </div>

        <!-- RIGHT COLUMN: STICKY BOOKING CARD -->
        <div class="col-lg-5 col-xl-4">
            <div class="card shadow-lg border rounded-4 p-4 sticky-top bg-white" style="top: 100px; z-index: 10;">
                
                <div class="d-flex justify-content-between align-items-baseline mb-4">
                    <div>
                        <span class="fs-4 fw-bold">$@Model.PricePerNight.ToString("N0")</span> 
                        <span class="text-muted"> night</span>
                    </div>
                    <div class="small fw-bold text-decoration-underline">
                        <i class="bi bi-star-fill text-danger small"></i> @ratingText · <span class="text-muted text-decoration-none">@reviewText</span>
                    </div>
                </div>

                <form asp-controller="Booking" asp-action="CreateCheckoutSession" method="post">
                    <input type="hidden" name="listingId" value="@Model.ListingId" />
                    <input type="hidden" name="price" value="@Model.PricePerNight" />
                    
                    <!-- Date Inputs -->
                    <div class="border rounded-3 mb-3 position-relative overflow-hidden">
                        <div class="d-flex border-bottom">
                            <div class="p-2 w-50 border-end position-relative">
                                <label class="small fw-bold d-block text-uppercase" style="font-size: 0.7rem;">Check-in</label>
                                <input type="date" id="checkInDate" name="checkIn" class="form-control border-0 p-0 shadow-none bg-transparent" required style="font-size: 0.9rem;">
                            </div>
                            <div class="p-2 w-50 position-relative">
                                <label class="small fw-bold d-block text-uppercase" style="font-size: 0.7rem;">Checkout</label>
                                <input type="date" id="checkOutDate" name="checkOut" class="form-control border-0 p-0 shadow-none bg-transparent" required style="font-size: 0.9rem;">
                            </div>
                        </div>
                        
                        <!-- Guest Dropdown (Dynamic Capacity) -->
                        <div class="p-2">
                            <label class="small fw-bold d-block text-uppercase" style="font-size: 0.7rem;">Guests</label>
                            <select name="guests" class="form-select border-0 p-0 shadow-none bg-transparent fw-light" style="font-size: 0.9rem;">
                                @for (int i = 1; i <= Model.Capacity; i++)
                                {
                                    <option value="@i">@i guest@(i > 1 ? "s" : "")</option>
                                }
                            </select>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-danger w-100 py-3 fw-bold rounded-3 mb-3 bg-gradient" style="background-color: #ff385c; border: none; font-size: 1.1rem;">
                        Reserve
                    </button>
                </form>

                <p class="text-center small text-muted mb-4">You won't be charged yet</p>

                <!-- Pricing Calculation -->
                <div id="priceBreakdown" class="d-none">
                    <div class="d-flex justify-content-between mb-2 text-muted">
                        <span class="text-decoration-underline">$@Model.PricePerNight x <span id="totalNights">0</span> nights</span>
                        <span>$<span id="subTotal">0</span></span>
                    </div>
                    <div class="d-flex justify-content-between mb-3 text-muted">
                        <span class="text-decoration-underline">Service fee</span>
                        <span>$50</span>
                    </div>
                    <hr class="my-3 opacity-25">
                    <div class="d-flex justify-content-between fw-bold fs-5">
                        <span>Total</span>
                        <span>$<span id="grandTotal">0</span></span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .hover-zoom { transition: transform 0.3s ease; }
    .hover-zoom:hover { transform: scale(1.02); }
    .hover-bg-gray:hover { background-color: #f7f7f7 !important; }
    .text-truncate-3 { display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; }
</style>

<script>
    const checkInInput = document.getElementById('checkInDate');
    const checkOutInput = document.getElementById('checkOutDate');
    const pricePerNight = @Model.PricePerNight;
    const serviceFee = 50;

    function calculateTotal() {
        const d1 = new Date(checkInInput.value);
        const d2 = new Date(checkOutInput.value);

        if (d1 && d2 && d2 > d1) {
            const diffTime = Math.abs(d2 - d1);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
            
            document.getElementById('totalNights').innerText = diffDays;
            document.getElementById('subTotal').innerText = (diffDays * pricePerNight).toLocaleString();
            document.getElementById('grandTotal').innerText = ((diffDays * pricePerNight) + serviceFee).toLocaleString();
            
            document.getElementById('priceBreakdown').classList.remove('d-none');
        } else {
            document.getElementById('priceBreakdown').classList.add('d-none');
        }
    }

    checkInInput.addEventListener('change', calculateTotal);
    checkOutInput.addEventListener('change', calculateTotal);
</script>