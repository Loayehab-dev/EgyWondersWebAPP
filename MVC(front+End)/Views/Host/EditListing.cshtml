@model MVC_front_End_.Models.ListingUpdateDTO

@{
    ViewData["Title"] = "Edit Listing";
    Layout = "~/Views/Shared/_HostLayout.cshtml";
    var allAmenities = ViewBag.AllAmenities as List<MVC_front_End_.Models.AmenityDTO>;
}

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style> #map { height: 300px; width: 100%; border-radius: 8px; z-index: 1; } </style>

<div class="dashboard-content">
    <div class="card border-0 shadow-sm rounded-4">
        <div class="card-body p-4">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h4 class="fw-bold mb-0">Edit Listing</h4>
                <a asp-action="Index" class="btn btn-outline-secondary btn-sm">Cancel</a>
            </div>

            <!-- FORM START -->
            <form asp-action="EditListing" asp-route-id="@Model.ListingId" method="post" enctype="multipart/form-data">
                
                <!-- CRITICAL: Hidden ID for Model Binding -->
                <input type="hidden" asp-for="ListingId" />

                <!-- Text Fields -->
                <div class="row g-3 mb-4">
                    <div class="col-md-8">
                        <label class="form-label fw-bold">Title</label>
                        <input asp-for="Title" class="form-control" />
                        <span asp-validation-for="Title" class="text-danger small"></span>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-bold">Category</label>
                        <select asp-for="Category" class="form-select">
                            <option value="Apartment">Apartment</option>
                            <option value="Villa">Villa</option>
                            <option value="Hotel">Hotel</option>
                            <option value="Cabin">Cabin</option>
                        </select>
                    </div>
                </div>

               

                <div class="row g-3 mb-4">
                    <div class="col-md-4">
                        <label class="form-label fw-bold">Price</label>
                        <input asp-for="PricePerNight" class="form-control" />
                        <span asp-validation-for="PricePerNight" class="text-danger small"></span>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-bold">Capacity</label>
                        <input asp-for="Capacity" class="form-control" />
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-bold">City</label>
                        <input asp-for="CityName" class="form-control" />
                    </div>
                </div>

                <!-- Map Section -->
                <div class="mb-4">
                    <label class="form-label fw-bold">Update Location</label>
                    <div id="map"></div>
                    <input type="hidden" asp-for="CityLatitude" id="latInput" />
                    <input type="hidden" asp-for="CityLongitude" id="lngInput" />
                </div>

                <!-- Amenities Checkboxes -->
                <h6 class="text-primary fw-bold mb-3"><i class="bi bi-stars"></i> Amenities</h6>
                <div class="mb-4 p-3 bg-light rounded">
                    <div class="row g-3">
                        @if (allAmenities != null)
                        {
                            foreach (var am in allAmenities)
                            {
                                <!-- Check if this amenity ID is in the current model list -->
                                var isChecked = Model.AmenityIds != null && Model.AmenityIds.Contains(am.AmenitiesId);

                                <div class="col-md-3 col-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" 
                                               name="AmenityIds" 
                                               value="@am.AmenitiesId" 
                                               id="am_@am.AmenitiesId"
                                               @(isChecked ? "checked" : "")>
                                        <label class="form-check-label" for="am_@am.AmenitiesId">@am.AmenityName</label>
                                    </div>
                                </div>
                            }
                        }
                    </div>
                </div>

                <!-- Photos Section -->
                <h6 class="text-primary fw-bold mb-3"><i class="bi bi-images"></i> Photos</h6>
                
                @if (Model.ExistingPhotos != null && Model.ExistingPhotos.Any())
                {
                    <label class="small text-muted mb-2">Current Photos:</label>
                    <div class="d-flex gap-2 mb-3 overflow-auto p-2 border rounded bg-white">
                        @foreach (var p in Model.ExistingPhotos)
                        {
                            <img src="https://localhost:7151@(p.Url)" style="width: 100px; height: 80px; object-fit: cover; border-radius: 5px;" onerror="this.style.display='none'"/>
                        }
                    </div>
                }

                <div class="mb-4">
                    <label class="form-label small fw-bold">Add New Photos</label>
                    <input asp-for="NewPhotos" type="file" class="form-control" multiple />
                </div>

                <div class="d-flex gap-2 mt-4">
                    <button type="submit" class="btn btn-primary px-5">Save Changes</button>
                    <a asp-action="Index" class="btn btn-secondary px-4">Cancel</a>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Map Script -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    var lat = @Model.CityLatitude;
    var lng = @Model.CityLongitude;

    // Safety check for map coords
    if (!lat || lat === 0) lat = 30.0444; 
    if (!lng || lng === 0) lng = 31.2357;

    var map = L.map('map').setView([lat, lng], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    
    var marker = L.marker([lat, lng], { draggable: true }).addTo(map);

    function updateInputs(l, lg) {
        document.getElementById('latInput').value = l;
        document.getElementById('lngInput').value = lg;
    }

    marker.on('dragend', function (e) {
        var pos = marker.getLatLng();
        updateInputs(pos.lat, pos.lng);
    });

    map.on('click', function(e) {
        marker.setLatLng(e.latlng);
        updateInputs(e.latlng.lat, e.latlng.lng);
    });
</script>